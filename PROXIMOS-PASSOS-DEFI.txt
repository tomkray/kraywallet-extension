â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸš€ KRAY DEFI - PRÃ“XIMOS PASSOS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ… JÃ IMPLEMENTADO:

1. Frontend DeFi Swap (defi-swap.html)
   - âœ… Connect wallet (MyWallet)
   - âœ… Carregar BTC balance
   - âœ… Carregar Runes via wallet.getRunes()
   - âœ… Modal de seleÃ§Ã£o de tokens
   - âœ… Thumbnails das runes
   - âœ… FormataÃ§Ã£o correta de amounts (sem dividir por divisibility)
   - âœ… BotÃ£o MAX para usar saldo total
   - âœ… CÃ¡lculo de quote em tempo real
   - âœ… UI moderna e responsiva

2. Backend DeFi
   - âœ… Pool Manager (AMM x*y=k)
   - âœ… PSBT Builder (Runes-aware)
   - âœ… Policy Engine (validaÃ§Ãµes)
   - âœ… Pool Signer (HD Wallet + LND ready)
   - âœ… API Routes (/api/defi/*)
   - âœ… Database schema (pools, swaps, liquidity)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âŒ FALTA IMPLEMENTAR:

1. CREATE POOL - FRONTEND
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Modal jÃ¡ criado em defi-swap.html (linha 532-583)
   
   Precisa adicionar JavaScript:
   
   a) Event listeners:
      - createPoolBtn.click â†’ openCreatePoolModal()
      - createPoolClose.click â†’ closeCreatePoolModal()
      - poolRuneBtn.click â†’ openTokenModal('pool')
      - poolRuneAmount.input â†’ calculateInitialPrice()
      - poolBtcAmount.input â†’ calculateInitialPrice()
      - poolRuneMaxBtn.click â†’ setPoolRuneMax()
      - poolBtcMaxBtn.click â†’ setPoolBtcMax()
      - createPoolSubmitBtn.click â†’ submitCreatePool()
   
   b) FunÃ§Ãµes necessÃ¡rias:
      - openCreatePoolModal()
      - closeCreatePoolModal()
      - calculateInitialPrice()
      - setPoolRuneMax()
      - setPoolBtcMax()
      - submitCreatePool() â†’ POST /api/defi/pools
   
   c) LÃ³gica:
      - Selecionar rune (somente runes, sem BTC)
      - Digitar amount de rune
      - Digitar amount de BTC
      - Mostrar preÃ§o inicial: 1 RUNE = X BTC
      - Validar: mÃ­nimo 1000 sats de BTC
      - Validar: amount > 0 para ambos
      - Criar pool via API

2. CREATE POOL - BACKEND
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   JÃ¡ existe POST /api/defi/pools em server/routes/defiSwap.js
   
   Mas precisa:
   
   a) Validar no policyEngine:
      - Rune ID vÃ¡lido
      - Amounts mÃ­nimos (BTC >= 1000 sats, Rune > 0)
      - Pool jÃ¡ nÃ£o existe
      - User tem balance suficiente
   
   b) Construir PSBT em psbtBuilder:
      - Input: BTC do user
      - Input: Rune do user (com OP_RETURN edict)
      - Output: BTC para pool address
      - Output: Rune para pool address
      - Output: LP tokens para user
      - Output: Fee para protocol
      - Output: Change
   
   c) Assinar com poolSigner:
      - User assina seus inputs (via MyWallet)
      - Pool assina inputs do pool (HD Wallet ou LND)
      - Finalizar e broadcast

3. SWAP - EXECUTAR
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Frontend jÃ¡ chama executeSwap(), mas estÃ¡ com TODO
   
   Precisa:
   
   a) Construir PSBT de swap:
      - Se BTC â†’ Rune:
        * Input: BTC do user
        * Output: BTC para pool
        * Output: Rune para user (OP_RETURN edict)
        * Output: LP fee
        * Output: Protocol fee
        * Output: Change
      
      - Se Rune â†’ BTC:
        * Input: Rune do user (com edict)
        * Input: BTC do pool
        * Output: Rune para pool
        * Output: BTC para user
        * Output: LP fee
        * Output: Protocol fee
        * Output: Change
   
   b) Assinar:
      - User assina com MyWallet
      - Pool assina com poolSigner
      - Broadcast
   
   c) Atualizar pool state:
      - Recalcular reserves (x*y=k)
      - Registrar swap no banco
      - Atualizar UI

4. ADD/REMOVE LIQUIDITY
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   Opcional para depois, mas importante:
   
   - Add Liquidity: Adicionar mais BTC+Rune a um pool existente
   - Remove Liquidity: Resgatar LP tokens e receber BTC+Rune

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ ORDEM RECOMENDADA:

1. HOJE: Implementar CREATE POOL frontend (JavaScript)
   - Event listeners
   - Modal open/close
   - Token selection para pool
   - Initial price calculation
   - API call

2. AMANHÃƒ: Implementar CREATE POOL backend
   - ValidaÃ§Ãµes no policyEngine
   - PSBT construction em psbtBuilder
   - Pool signing
   - Database insert
   - Testar criar primeiro pool

3. DEPOIS: Implementar SWAP execution
   - PSBT construction para swap
   - User + Pool signing
   - Broadcast
   - Pool state update
   - Testar swap completo

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ CHECKLIST PARA CREATE POOL:

Frontend (defi-swap.html):
[ ] Add event listener: createPoolBtn â†’ openCreatePoolModal()
[ ] Add event listener: createPoolClose â†’ closeCreatePoolModal()
[ ] Add event listener: poolRuneBtn â†’ openTokenModal('pool')
[ ] Add event listener: poolRuneAmount.input â†’ calculateInitialPrice()
[ ] Add event listener: poolBtcAmount.input â†’ calculateInitialPrice()
[ ] Add event listener: createPoolSubmitBtn â†’ submitCreatePool()
[ ] Function: openCreatePoolModal()
[ ] Function: closeCreatePoolModal()
[ ] Function: calculateInitialPrice()
[ ] Function: submitCreatePool()
[ ] Handle token selection para 'pool'
[ ] Validar inputs antes de submit
[ ] Mostrar loading durante criaÃ§Ã£o
[ ] Mostrar sucesso/erro
[ ] Atualizar lista de pools apÃ³s criar

Backend (server/routes/defiSwap.js):
[ ] Validar rune ID existe
[ ] Validar amounts mÃ­nimos
[ ] Validar pool nÃ£o existe
[ ] Validar user tem balance
[ ] Construir PSBT (psbtBuilder.js)
[ ] Validar PSBT (policyEngine.js)
[ ] Assinar com pool (poolSigner.js)
[ ] Inserir no database
[ ] Retornar pool criado

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

URL: http://localhost:3000/defi-swap.html

Status: Frontend 80% pronto, Backend 90% pronto
Falta: Conectar CREATE POOL e SWAP execution



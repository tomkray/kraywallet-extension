<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KRAY STATION - Ordinals Marketplace</title>
    <link rel="icon" type="image/png" href="kraywallet/logotk.png">
    <link rel="apple-touch-icon" href="kraywallet/logotk.png">
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <img src="kraywallet/logo.png" alt="KRAY STATION Logo" class="nav-logo">
                <div class="nav-title">
                    <h1>KRAY STATION</h1>
                    <span class="nav-subtitle">Bitcoin Ordinals & Runes</span>
                </div>
            </div>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Home</a>
                <a href="ordinals.html" class="nav-link active">Ordinals</a>
                <a href="runes-swap.html" class="nav-link">Runes (On-chain)</a>
                <a href="lightning-hub.html" class="nav-link">‚ö° Lightning DEX</a>
                <button class="wallet-btn" id="connectWallet">
                    <span class="wallet-text">Connect Wallet</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="container">
        <div class="tabs">
            <button class="tab-btn active" data-tab="browse">üî• Marketplace</button>
            <button class="tab-btn" data-tab="create-offer">Create Offer</button>
            <button class="tab-btn" data-tab="my-offers">My Offers</button>
            <button class="tab-btn" data-tab="wallet-sweep">Wallet Sweep</button>
        </div>

        <!-- üî• Marketplace Tab -->
        <div class="tab-content active" id="browse">
            <div class="filters">
                <input type="text" id="searchOrdinals" placeholder="Search by inscription ID or number...">
                <select id="sortBy">
                    <option value="popular">üî• Most Liked</option>
                    <option value="recent">Most Recent</option>
                    <option value="price-low">Price: Low to High</option>
                    <option value="price-high">Price: High to Low</option>
                    <option value="number">Inscription Number</option>
                </select>
            </div>

            <div class="ordinals-grid" id="marketplaceGrid">
                <!-- Marketplace listings will be loaded here -->
            </div>
            
            <!-- Pagina√ß√£o Marketplace -->
            <div class="pagination" id="browseOrdinalsPagination" style="display: none; margin-top: var(--spacing-3xl); display: flex; justify-content: center; align-items: center; gap: var(--spacing-md);">
                <button id="browsePrevBtn" class="pagination-btn" style="padding: 10px 20px; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text-primary); cursor: pointer; font-weight: 600; transition: all var(--transition-base);" disabled>
                    ‚Üê Previous
                </button>
                <span id="browsePageInfo" style="color: var(--color-text-secondary); font-size: 14px; font-weight: 500; min-width: 150px; text-align: center;">
                    Page 1
                </span>
                <button id="browseNextBtn" class="pagination-btn" style="padding: 10px 20px; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text-primary); cursor: pointer; font-weight: 600; transition: all var(--transition-base);">
                    Next ‚Üí
                </button>
            </div>
        </div>

        <!-- Create Offer Tab -->
        <div class="tab-content" id="create-offer">
            <!-- Wallet Connected - Show Inscriptions with FILTERS (IGUAL Marketplace) -->
            <div id="wallet-inscriptions-section" style="display: none;">
                <!-- FILTERS (ID√äNTICOS ao Marketplace) -->
                <div class="filters">
                    <input type="text" id="searchMyInscriptions" placeholder="Search your inscriptions by ID or number...">
                    <select id="sortMyInscriptions">
                        <option value="recent">Most Recent</option>
                        <option value="number-high">Inscription Number: High to Low</option>
                        <option value="number-low">Inscription Number: Low to High</option>
                        <option value="type">Content Type</option>
                    </select>
                </div>
                
                <!-- Loading Spinner -->
                <div id="inscriptions-loading" style="text-align: center; padding: var(--spacing-4xl); display: none;">
                    <div class="loading-spinner" style="width: 48px; height: 48px; border: 3px solid var(--color-border); border-top-color: var(--color-text-primary); border-radius: 50%; margin: 0 auto;"></div>
                    <p style="color: var(--color-text-secondary); margin-top: var(--spacing-lg); font-size: 14px;">Loading inscriptions...</p>
                </div>
                
                <!-- Inscriptions Grid (ID√äNTICO ao Marketplace) -->
                <div class="ordinals-grid" id="wallet-inscriptions-grid">
                    <!-- Inscriptions will be loaded here -->
                </div>
                
                <!-- No Inscriptions Message -->
                <div id="no-inscriptions-message" style="display: none; text-align: center; padding: var(--spacing-4xl); background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-lg); margin-top: var(--spacing-2xl);">
                    <div style="font-size: 48px; margin-bottom: var(--spacing-lg); opacity: 0.5;">üì≠</div>
                    <h4 style="margin: 0 0 var(--spacing-sm) 0; color: var(--color-text-primary); font-weight: 600;">No Inscriptions Found</h4>
                    <p style="margin: 0; color: var(--color-text-secondary); font-size: 14px;">Your wallet doesn't have any inscriptions yet</p>
                </div>
                
                <!-- Pagina√ß√£o Create Offer -->
                <div class="pagination" id="createOfferPagination" style="display: none; margin-top: var(--spacing-3xl); display: flex; justify-content: center; align-items: center; gap: var(--spacing-md);">
                    <button id="createPrevBtn" class="pagination-btn" style="padding: 10px 20px; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text-primary); cursor: pointer; font-weight: 600; transition: all var(--transition-base);" disabled>
                        ‚Üê Previous
                    </button>
                    <span id="createPageInfo" style="color: var(--color-text-secondary); font-size: 14px; font-weight: 500; min-width: 150px; text-align: center;">
                        Page 1
                    </span>
                    <button id="createNextBtn" class="pagination-btn" style="padding: 10px 20px; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text-primary); cursor: pointer; font-weight: 600; transition: all var(--transition-base);">
                        Next ‚Üí
                    </button>
                </div>
            </div>
            
            <!-- Wallet NOT Connected - Show Options -->
            <div id="wallet-selection-section">
            <!-- Wallet Type Selection -->
            <div style="background: var(--color-bg-secondary); padding: var(--spacing-3xl); border-radius: var(--radius-lg); margin-bottom: var(--spacing-3xl); border: 1px solid var(--color-border);">
                <h3 style="margin: 0 0 var(--spacing-2xl) 0; font-size: 24px; color: var(--color-text-primary); font-weight: 600; letter-spacing: -0.5px;">Choose Your Wallet</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-2xl);">
                    <!-- Kray Wallet Option -->
                    <div style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border-hover); border-radius: var(--radius-lg); padding: var(--spacing-2xl); cursor: pointer; transition: all var(--transition-base);" onmouseover="this.style.borderColor='var(--color-text-primary)'" onmouseout="this.style.borderColor='var(--color-border-hover)'" onclick="window.open('chrome-extension://your-extension-id/popup.html', '_blank')">
                        <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                            <div style="width: 40px; height: 40px; background: var(--color-text-primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">üîë</div>
                            <h4 style="margin: 0; color: var(--color-text-primary); font-weight: 600; font-size: 18px;">Kray Wallet</h4>
                        </div>
                        <p style="margin: 0 0 var(--spacing-lg) 0; color: var(--color-text-secondary); font-size: 13px; line-height: 1.5;">List your inscriptions instantly</p>
                        <ul style="list-style: none; padding: 0; margin: 0 0 var(--spacing-lg) 0;">
                            <li style="color: var(--color-text-secondary); margin: var(--spacing-xs) 0; font-size: 13px; display: flex; align-items: center; gap: 8px;"><span style="color: var(--color-text-primary);">‚Ä¢</span> 0% fee</li>
                            <li style="color: var(--color-text-secondary); margin: var(--spacing-xs) 0; font-size: 13px; display: flex; align-items: center; gap: 8px;"><span style="color: var(--color-text-primary);">‚Ä¢</span> 1-click listing</li>
                            <li style="color: var(--color-text-secondary); margin: var(--spacing-xs) 0; font-size: 13px; display: flex; align-items: center; gap: 8px;"><span style="color: var(--color-text-primary);">‚Ä¢</span> Social features</li>
                        </ul>
                        <button style="width: 100%; padding: 12px; background: var(--color-text-primary); border: none; border-radius: var(--radius-md); color: var(--color-bg-primary); font-weight: 600; cursor: pointer; font-size: 14px; transition: all var(--transition-base);" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'" onclick="alert('Open Kray Wallet extension and click List on Market!')">
                            Open Extension
                        </button>
                    </div>
                    
                    <!-- Other Wallets Option -->
                    <div style="background: var(--color-bg-tertiary); border: 1px solid var(--color-border-hover); border-radius: var(--radius-lg); padding: var(--spacing-2xl); cursor: pointer; transition: all var(--transition-base);" onmouseover="this.style.borderColor='var(--color-text-secondary)'" onmouseout="this.style.borderColor='var(--color-border-hover)'">
                        <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-lg);">
                            <div style="width: 40px; height: 40px; background: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">üíº</div>
                            <h4 style="margin: 0; color: var(--color-text-primary); font-weight: 600; font-size: 18px;">Other Wallets</h4>
                        </div>
                        <p style="margin: 0 0 var(--spacing-lg) 0; color: var(--color-text-secondary); font-size: 13px; line-height: 1.5;">Use ORD CLI to create offers</p>
                        <ul style="list-style: none; padding: 0; margin: 0 0 var(--spacing-lg) 0;">
                            <li style="color: var(--color-text-secondary); margin: var(--spacing-xs) 0; font-size: 13px; display: flex; align-items: center; gap: 8px;"><span style="color: var(--color-text-tertiary);">‚Ä¢</span> 1% service fee</li>
                            <li style="color: var(--color-text-secondary); margin: var(--spacing-xs) 0; font-size: 13px; display: flex; align-items: center; gap: 8px;"><span style="color: var(--color-text-tertiary);">‚Ä¢</span> ORD CLI required</li>
                            <li style="color: var(--color-text-secondary); margin: var(--spacing-xs) 0; font-size: 13px; display: flex; align-items: center; gap: 8px;"><span style="color: var(--color-text-tertiary);">‚Ä¢</span> Terminal access</li>
                        </ul>
                        <button style="width: 100%; padding: 12px; background: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text-primary); font-weight: 600; cursor: pointer; font-size: 14px; transition: all var(--transition-base);" onmouseover="this.style.borderColor='var(--color-text-primary)'" onmouseout="this.style.borderColor='var(--color-border)'" onclick="document.getElementById('ord-cli-form').scrollIntoView({behavior: 'smooth'})">
                            Generate Command
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- ORD CLI Form -->
            <div class="offer-form" id="ord-cli-form" style="background: var(--color-bg-secondary); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--spacing-3xl); margin-top: var(--spacing-3xl);">
                <div style="display: flex; align-items: center; gap: var(--spacing-lg); margin-bottom: var(--spacing-2xl); padding-bottom: var(--spacing-2xl); border-bottom: 1px solid var(--color-border);">
                    <div style="width: 48px; height: 48px; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 24px;">‚ö°</div>
                    <div>
                        <h3 style="margin: 0; color: var(--color-text-primary); font-weight: 600; font-size: 20px; letter-spacing: -0.5px;">ORD CLI Generator</h3>
                        <p class="subtitle" style="margin: 5px 0 0 0; color: var(--color-text-secondary); font-size: 13px;">For external wallet users (Unisat, Xverse, Leather)</p>
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: var(--spacing-2xl);">
                    <label for="inscriptionId" style="display: block; margin-bottom: var(--spacing-sm); color: var(--color-text-primary); font-weight: 500; font-size: 14px;">Inscription ID</label>
                    <input type="text" id="inscriptionId" placeholder="abc123def456...i0" style="width: 100%; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); font-size: 14px; padding: 12px 16px; border-radius: var(--radius-md); color: var(--color-text-primary); font-family: var(--font-mono); transition: all var(--transition-base);" onfocus="this.style.borderColor='var(--color-text-primary)'" onblur="this.style.borderColor='var(--color-border)'">
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--spacing-xs); font-size: 12px;">Enter the full inscription ID (ending in i0)</small>
                </div>

                <div class="form-group" style="margin-bottom: var(--spacing-2xl);">
                    <label for="offerAmount" style="display: block; margin-bottom: var(--spacing-sm); color: var(--color-text-primary); font-weight: 500; font-size: 14px;">Offer Amount (sats)</label>
                    <input type="number" id="offerAmount" placeholder="e.g. 50000" style="width: 100%; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); font-size: 14px; padding: 12px 16px; border-radius: var(--radius-md); color: var(--color-text-primary); font-family: var(--font-mono); transition: all var(--transition-base);" onfocus="this.style.borderColor='var(--color-text-primary)'" onblur="this.style.borderColor='var(--color-border)'">
                    <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--spacing-xs); font-size: 12px;">
                        <span style="color: var(--color-text-secondary); font-weight: 500;">Note:</span> 1% service fee applies (you receive 99%)
                    </small>
                </div>

                <!-- Hidden fee rate field with default value -->
                <input type="hidden" id="feeRate" value="10">

                <div class="form-actions">
                    <button class="btn btn-primary" id="generateOrdCommandBtn" style="width: 100%; background: var(--color-text-primary); color: var(--color-bg-primary); border: none; padding: 14px; border-radius: var(--radius-md); font-weight: 600; font-size: 14px; cursor: pointer; transition: all var(--transition-base);" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                        Generate Command
                    </button>
                </div>
                
                <!-- Generated Command Display -->
                <div id="ordCommandDisplay" style="display: none; margin-top: var(--spacing-3xl); background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-lg); padding: var(--spacing-2xl);">
                    <h4 style="color: var(--color-text-primary); margin: 0 0 var(--spacing-lg) 0; font-weight: 600; font-size: 16px;">Generated Command</h4>
                    
                    <div style="background: var(--color-bg-card); padding: var(--spacing-lg); border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 13px; color: var(--color-text-primary); margin-bottom: var(--spacing-lg); position: relative; overflow-x: auto; border: 1px solid var(--color-border);">
                        <code id="ordCommandText" style="white-space: pre-wrap; word-break: break-all; line-height: 1.6;"></code>
                        <button onclick="copyOrdCommand()" style="position: absolute; top: var(--spacing-sm); right: var(--spacing-sm); background: var(--color-text-primary); border: none; padding: 8px 16px; border-radius: var(--radius-sm); color: var(--color-bg-primary); cursor: pointer; font-size: 12px; font-weight: 600; transition: all var(--transition-base);" onmouseover="this.style.opacity='0.9'" onmouseout="this.style.opacity='1'">
                            Copy
                        </button>
                    </div>
                    
                    <div style="background: var(--color-bg-secondary); border-left: 2px solid var(--color-text-primary); padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
                        <h5 style="margin: 0 0 var(--spacing-md) 0; color: var(--color-text-primary); font-weight: 600; font-size: 14px;">Next Steps</h5>
                        <ol style="margin: 0; padding-left: 20px; color: var(--color-text-secondary); font-size: 13px; line-height: 1.8;">
                            <li style="margin: var(--spacing-xs) 0;">Copy the command above</li>
                            <li style="margin: var(--spacing-xs) 0;">Open your terminal</li>
                            <li style="margin: var(--spacing-xs) 0;">Ensure ORD CLI and Bitcoin Core are running</li>
                            <li style="margin: var(--spacing-xs) 0;">Paste and execute the command</li>
                            <li style="margin: var(--spacing-xs) 0;">Your offer appears in ~5 minutes</li>
                        </ol>
                        <p style="margin: var(--spacing-md) 0 0 0; padding-top: var(--spacing-md); border-top: 1px solid var(--color-border); font-size: 12px; color: var(--color-text-tertiary);">
                            üí° Buyer pays network fees at purchase
                        </p>
                    </div>
                    
                    <div style="background: var(--color-bg-secondary); border-left: 2px solid var(--color-text-secondary); padding: var(--spacing-lg); border-radius: var(--radius-md);">
                        <h5 style="margin: 0 0 var(--spacing-md) 0; color: var(--color-text-primary); font-weight: 600; font-size: 14px;">Fee Breakdown</h5>
                        <div style="color: var(--color-text-secondary); font-size: 13px;">
                            <div style="display: flex; justify-content: space-between; margin: var(--spacing-xs) 0;">
                                <span>Offer price:</span>
                                <span id="feeBreakdownPrice" style="color: var(--color-text-primary); font-weight: 600; font-family: var(--font-mono);">0 sats</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: var(--spacing-xs) 0;">
                                <span>Service fee (1%):</span>
                                <span id="feeBreakdownService" style="color: var(--color-text-secondary); font-weight: 600; font-family: var(--font-mono);">0 sats</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: var(--spacing-xs) 0; padding-top: var(--spacing-sm); border-top: 1px solid var(--color-border);">
                                <span style="font-weight: 600; color: var(--color-text-primary);">You receive:</span>
                                <span id="feeBreakdownYouGet" style="color: var(--color-text-primary); font-weight: 700; font-size: 15px; font-family: var(--font-mono);">0 sats</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="psbt-output" id="psbtOutput" style="display: none;">
                    <h4>Generated PSBT:</h4>
                    <textarea id="psbtText" readonly></textarea>
                    <button class="btn btn-small" id="copyPSBTBtn">Copy PSBT</button>
                </div>
            </div>
            </div> <!-- Close wallet-selection-section -->
        </div>

        <!-- My Offers Tab -->
        <div class="tab-content" id="my-offers">
            <div class="ordinals-grid" id="myOffersGrid">
                <!-- My listings will be loaded here with Cancel & Update Price buttons -->
            </div>
        </div>

        <!-- Wallet Sweep Tab -->
        <div class="tab-content" id="wallet-sweep">
            <div class="sweep-form">
                <h3>Wallet Sweep</h3>
                <p class="subtitle">New feature in v0.23.3 - Sweep all UTXOs from your wallet</p>
                
                <div class="form-group">
                    <label for="sweepAddress">Destination Address</label>
                    <input type="text" id="sweepAddress" placeholder="Enter Bitcoin address">
                </div>

                <div class="form-group">
                    <label for="sweepFeeRate">Fee Rate (sat/vB)</label>
                    <input type="number" id="sweepFeeRate" placeholder="Fee rate" value="10">
                </div>

                <div class="warning-box">
                    <strong>‚ö†Ô∏è Warning:</strong> This will sweep ALL UTXOs from your wallet to the destination address.
                    Make sure you have backed up your wallet and verified the destination address.
                </div>

                <div class="form-actions">
                    <button class="btn btn-danger" id="sweepWalletBtn">Sweep Wallet</button>
                </div>

                <div class="sweep-output" id="sweepOutput" style="display: none;">
                    <h4>Sweep Transaction:</h4>
                    <textarea id="sweepTxText" readonly></textarea>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>Built with Ordinals Protocol v0.23.3 | PSBT Offers Support | <a href="https://github.com/ordinals/ord" target="_blank">GitHub</a></p>
        </div>
    </footer>

    <!-- Wallet Selection Modal -->
    <div id="walletModal" class="modal hidden">
        <div class="modal-overlay" onclick="closeWalletModal()"></div>
        <div class="modal-content wallet-modal">
            <div class="modal-header">
                <h3>Connect Wallet</h3>
                <button class="modal-close" onclick="closeWalletModal()">√ó</button>
            </div>
            <div class="modal-body">
                <p class="modal-subtitle">Choose your preferred wallet to connect</p>
                <div class="wallet-options">
                    <!-- MyWallet -->
                    <button class="wallet-option" onclick="connectMyWallet()">
                        <img src="kraywallet/logotk.png" alt="MyWallet" class="wallet-icon">
                        <div class="wallet-info">
                            <span class="wallet-name">MyWallet</span>
                            <span class="wallet-tag recommended">Recommended</span>
                        </div>
                        <span class="wallet-arrow">‚Üí</span>
                    </button>

                    <!-- Unisat -->
                    <button class="wallet-option" onclick="connectUnisat()">
                        <img src="public/images/unisat.png" alt="Unisat" class="wallet-icon">
                        <div class="wallet-info">
                            <span class="wallet-name">Unisat</span>
                            <span class="wallet-tag">Popular</span>
                        </div>
                        <span class="wallet-arrow">‚Üí</span>
                    </button>

                    <!-- Xverse -->
                    <button class="wallet-option" onclick="connectXverse()">
                        <img src="public/images/xverse.png" alt="Xverse" class="wallet-icon">
                        <div class="wallet-info">
                            <span class="wallet-name">Xverse</span>
                            <span class="wallet-tag">Trusted</span>
                        </div>
                        <span class="wallet-arrow">‚Üí</span>
                    </button>
                </div>
                <div class="wallet-help">
                    <p>Don't have a wallet? <a href="https://chrome.google.com/webstore" target="_blank">Get one here</a></p>
                </div>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script src="app.js"></script>
    
    <script>
    // ORD CLI Command Generator
    document.getElementById('generateOrdCommandBtn')?.addEventListener('click', function() {
        const inscriptionId = document.getElementById('inscriptionId').value.trim();
        const offerAmount = parseInt(document.getElementById('offerAmount').value);
        const feeRate = parseInt(document.getElementById('feeRate').value) || 10;
        
        if (!inscriptionId) {
            alert('‚ùå Please enter an Inscription ID');
            return;
        }
        
        if (!offerAmount || offerAmount <= 0) {
            alert('‚ùå Please enter a valid offer amount');
            return;
        }
        
        // Generate ORD CLI command (sem --fee-rate, pois o buyer paga!)
        const ordCommand = `ord wallet offer create \\
  --inscription ${inscriptionId} \\
  --price ${offerAmount}`;
        
        // Calculate fees
        const serviceFee = Math.floor(offerAmount * 0.01); // 1%
        const youWillReceive = offerAmount - serviceFee;
        
        // Display command
        document.getElementById('ordCommandText').textContent = ordCommand;
        document.getElementById('feeBreakdownPrice').textContent = offerAmount.toLocaleString() + ' sats';
        document.getElementById('feeBreakdownService').textContent = serviceFee.toLocaleString() + ' sats';
        document.getElementById('feeBreakdownYouGet').textContent = youWillReceive.toLocaleString() + ' sats';
        
        document.getElementById('ordCommandDisplay').style.display = 'block';
        document.getElementById('ordCommandDisplay').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    });
    
    // Copy command to clipboard
    function copyOrdCommand() {
        const commandText = document.getElementById('ordCommandText').textContent;
        navigator.clipboard.writeText(commandText).then(() => {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Copied!';
            btn.style.background = '#4CAF50';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '#FF9800';
            }, 2000);
        });
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üñºÔ∏è LOAD WALLET INSCRIPTIONS (Create Offer Tab)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // üîí FLAG PARA EVITAR CHAMADAS DUPLICADAS
    let isLoadingInscriptions = false;
    
    async function loadWalletInscriptions() {
        // üõ°Ô∏è EVITAR CHAMADAS DUPLICADAS
        if (isLoadingInscriptions) {
            console.log('‚ö†Ô∏è  loadWalletInscriptions() already running, skipping...');
            return;
        }
        
        isLoadingInscriptions = true;
        console.log('üöÄ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        console.log('üöÄ loadWalletInscriptions() CALLED!');
        console.log('üöÄ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        const walletInscriptionsSection = document.getElementById('wallet-inscriptions-section');
        const walletSelectionSection = document.getElementById('wallet-selection-section');
        
        // üîç Detectar wallet conectada DIRETAMENTE (n√£o depender de vari√°veis do app.js)
        let walletAddress = null;
        let walletType = localStorage.getItem('walletType') || null;
        
        console.log(`üìã walletType from localStorage: ${walletType}`);
        
        try {
            if (walletType === 'kraywallet' && window.krayWallet) {
                const response = await window.krayWallet.connect();
                if (response && response.success && response.address) {
                    walletAddress = response.address;
                }
            } else if (walletType === 'unisat' && window.unisat) {
                const accounts = await window.unisat.getAccounts();
                walletAddress = accounts && accounts.length > 0 ? accounts[0] : null;
            } else if (walletType === 'xverse' && window.XverseProviders?.BitcoinProvider) {
                const response = await window.XverseProviders.BitcoinProvider.request('getAddresses');
                walletAddress = response?.addresses?.[0]?.address || null;
            } else {
                // Tentar detectar qualquer wallet
                if (window.unisat) {
                    const accounts = await window.unisat.getAccounts();
                    if (accounts && accounts.length > 0) {
                        walletAddress = accounts[0];
                        walletType = 'unisat';
                    }
                } else if (window.krayWallet) {
                    const response = await window.krayWallet.connect();
                    if (response && response.success && response.address) {
                        walletAddress = response.address;
                        walletType = 'kraywallet';
                    }
                }
            }
        } catch (error) {
            console.log('‚ö†Ô∏è Wallet not connected or error:', error.message);
        }
        
        if (!walletAddress) {
            // Wallet NOT connected - show wallet selection
            walletInscriptionsSection.style.display = 'none';
            walletSelectionSection.style.display = 'block';
            return;
        }
        
        console.log(`‚úÖ Wallet detected: ${walletType} - ${walletAddress}`);
        
        // üíæ SALVAR walletAddress no localStorage
        localStorage.setItem('walletAddress', walletAddress);
        localStorage.setItem('walletType', walletType);
        console.log('üíæ Wallet info saved to localStorage');
        
        // Wallet IS connected - load inscriptions
        walletInscriptionsSection.style.display = 'block';
        walletSelectionSection.style.display = 'none';
        
        const loadingDiv = document.getElementById('inscriptions-loading');
        const gridDiv = document.getElementById('wallet-inscriptions-grid');
        const noInscriptionsDiv = document.getElementById('no-inscriptions-message');
        
        loadingDiv.style.display = 'block';
        gridDiv.style.display = 'none';
        noInscriptionsDiv.style.display = 'none';
        
        try {
            console.log(`üîç Loading inscriptions for ${walletAddress}...`);
            
            const response = await fetch(`${CONFIG.API_URL}/ordinals/by-address/${walletAddress}`);
            const data = await response.json();
            
            if (!data.success || !data.inscriptions || data.inscriptions.length === 0) {
                loadingDiv.style.display = 'none';
                noInscriptionsDiv.style.display = 'block';
                return;
            }
            
            const inscriptions = data.inscriptions;
            console.log(`‚úÖ Found ${inscriptions.length} inscriptions`);
            
            // Guardar inscriptions globalmente para filtros/busca
            window.myInscriptions = inscriptions;
            
            // Renderizar inscriptions
            renderMyInscriptions(inscriptions);
            
            loadingDiv.style.display = 'none';
            gridDiv.style.display = 'grid';
            
        } catch (error) {
            console.error('‚ùå Error loading inscriptions:', error);
            loadingDiv.innerHTML = `
                <div style="color: #f44336;">
                    <p>‚ùå Error loading inscriptions</p>
                    <p style="font-size: 14px;">${error.message}</p>
                </div>
            `;
        } finally {
            // üîì LIBERAR FLAG PARA PR√ìXIMA CHAMADA
            isLoadingInscriptions = false;
            console.log('üîì loadWalletInscriptions() finished, flag released');
        }
    }
    
    // Vari√°veis de pagina√ß√£o Create Offer
    let currentCreatePage = 1;
    const itemsPerPage = 40;
    
    // Renderizar inscriptions na grid (com filtros/busca e PAGINA√á√ÉO)
    async function renderMyInscriptions(inscriptions) {
        const gridDiv = document.getElementById('wallet-inscriptions-grid');
        const noInscriptionsDiv = document.getElementById('no-inscriptions-message');
        const paginationDiv = document.getElementById('createOfferPagination');
        const pageInfo = document.getElementById('createPageInfo');
        const prevBtn = document.getElementById('createPrevBtn');
        const nextBtn = document.getElementById('createNextBtn');
        
        if (!inscriptions || inscriptions.length === 0) {
            gridDiv.style.display = 'none';
            noInscriptionsDiv.style.display = 'block';
            paginationDiv.style.display = 'none';
            return;
        }
        
        // Calcular pagina√ß√£o
        const totalPages = Math.ceil(inscriptions.length / itemsPerPage);
        const startIndex = (currentCreatePage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedInscriptions = inscriptions.slice(startIndex, endIndex);
        
        // Renderizar apenas a p√°gina atual
        gridDiv.innerHTML = '';
        noInscriptionsDiv.style.display = 'none';
        gridDiv.style.display = 'grid';
        
        let validCount = 0;
        // üî• USAR PROMISE.ALL PARA RENDERIZAR CARDS EM PARALELO
        const cardPromises = paginatedInscriptions.map(async (inscription, index) => {
            try {
                const card = await createInscriptionCard(inscription);
                if (card && card.innerHTML) {
                    gridDiv.appendChild(card);
                    validCount++;
                }
            } catch (error) {
                console.error(`‚ùå Error creating card:`, error, inscription);
            }
        });
        
        await Promise.all(cardPromises);
        
        // Atualizar pagina√ß√£o
        pageInfo.textContent = `Page ${currentCreatePage} of ${totalPages} (${inscriptions.length} total)`;
        prevBtn.disabled = currentCreatePage === 1;
        nextBtn.disabled = currentCreatePage === totalPages;
        paginationDiv.style.display = totalPages > 1 ? 'flex' : 'none';
        
        console.log(`‚úÖ Showing ${validCount} inscriptions (page ${currentCreatePage}/${totalPages})`);
        
        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Filtrar e ordenar inscriptions (AGORA COM BUSCA NO BACKEND)
    async function filterAndSortMyInscriptions() {
        console.log('üîç filterAndSortMyInscriptions() called!');
        
        const searchTerm = document.getElementById('searchMyInscriptions')?.value?.trim() || '';
        const sortBy = document.getElementById('sortMyInscriptions')?.value || 'recent';
        
        console.log(`üìù Search term: "${searchTerm}"`);
        console.log(`üìä Sort by: ${sortBy}`);
        
        // Resetar para p√°gina 1 quando filtrar/buscar
        currentCreatePage = 1;
        
        // üîç SE TEM BUSCA, CHAMAR API COM QUERY
        if (searchTerm) {
            console.log('üåê Calling API with search query...');
            
            // Pegar address da wallet conectada
            const walletType = localStorage.getItem('walletType');
            let walletAddress = null;
            
            try {
                if (walletType === 'kraywallet' && window.krayWallet) {
                    const response = await window.krayWallet.connect();
                    if (response && response.success && response.address) {
                        walletAddress = response.address;
                    }
                } else if (walletType === 'unisat' && window.unisat) {
                    const accounts = await window.unisat.getAccounts();
                    walletAddress = accounts && accounts.length > 0 ? accounts[0] : null;
                } else if (walletType === 'xverse' && window.XverseProviders?.BitcoinProvider) {
                    const response = await window.XverseProviders.BitcoinProvider.request('getAddresses');
                    walletAddress = response?.addresses?.[0]?.address || null;
                }
            } catch (error) {
                console.error('‚ùå Error getting wallet address:', error);
                return;
            }
            
            if (!walletAddress) {
                console.log('‚ö†Ô∏è  No wallet connected!');
                return;
            }
            
            // üîç CHAMAR NOVO ENDPOINT DEDICADO PARA BUSCA DIN√ÇMICA
            // Este endpoint busca DIRETO no ORD server, n√£o depende de cache/limite
            try {
                console.log(`   üì° Calling: /api/ordinals/search-by-wallet/${walletAddress}/${searchTerm}`);
                const response = await fetch(`${CONFIG.API_URL}/ordinals/search-by-wallet/${walletAddress}/${encodeURIComponent(searchTerm)}`);
                const data = await response.json();
                
                if (data.success && data.inscriptions) {
                    console.log(`‚úÖ API returned ${data.inscriptions.length} results`);
                    
                    // Ordenar localmente
                    let filtered = data.inscriptions.sort((a, b) => {
                        const aNumber = a.inscription_number || a.number || 0;
                        const bNumber = b.inscription_number || b.number || 0;
                        const aType = a.content_type || '';
                        const bType = b.content_type || '';
                        
                        switch(sortBy) {
                            case 'number-high':
                                return bNumber - aNumber;
                            case 'number-low':
                                return aNumber - bNumber;
                            case 'type':
                                return aType.localeCompare(bType);
                            case 'recent':
                            default:
                                return bNumber - aNumber;
                        }
                    });
                    
                    window.myInscriptionsFiltered = filtered;
                    renderMyInscriptions(filtered);
                } else {
                    console.log('‚ö†Ô∏è  No results from API');
                    window.myInscriptionsFiltered = [];
                    renderMyInscriptions([]);
                }
            } catch (error) {
                console.error('‚ùå Error calling API:', error);
            }
            
        } else {
            // SEM BUSCA, usar cache local
            if (!window.myInscriptions) {
                console.log('‚ö†Ô∏è  No inscriptions loaded yet!');
                return;
            }
            
            console.log(`üì¶ Total inscriptions (local): ${window.myInscriptions.length}`);
            
            // Ordenar localmente
            let filtered = [...window.myInscriptions].sort((a, b) => {
                const aNumber = a.inscription_number || a.number || 0;
                const bNumber = b.inscription_number || b.number || 0;
                const aType = a.content_type || '';
                const bType = b.content_type || '';
                
                switch(sortBy) {
                    case 'number-high':
                        return bNumber - aNumber;
                    case 'number-low':
                        return aNumber - bNumber;
                    case 'type':
                        return aType.localeCompare(bType);
                    case 'recent':
                    default:
                        return bNumber - aNumber;
                }
            });
            
            window.myInscriptionsFiltered = filtered;
            renderMyInscriptions(filtered);
        }
    }
    
    // Create inscription card with "List" button (SAME STYLE as Marketplace)
    async function createInscriptionCard(inscription) {
        const card = document.createElement('div');
        card.className = 'ordinal-card';
        
        // ‚ö†Ô∏è CR√çTICO: Backend retorna 'inscription_id', n√£o 'id'!
        const inscriptionId = inscription.id || inscription.inscription_id;
        
        // Validar inscription ID
        if (!inscription || !inscriptionId || typeof inscriptionId !== 'string') {
            console.warn('‚ö†Ô∏è Invalid inscription:', inscription);
            return document.createElement('div'); // Retorna div vazia
        }
        
        // Buscar conte√∫do do Ord Server via nosso endpoint
        const contentUrl = `${CONFIG.API_URL}/ordinals/${inscriptionId}/content`;
        const inscriptionNumber = inscription.inscription_number || inscription.number || 'N/A';
        
        // üîç VERIFICAR SE A INSCRI√á√ÉO J√Å EST√Å LISTADA
        let isListed = false;
        let listingInfo = null;
        const walletAddress = localStorage.getItem('walletAddress');
        
        if (walletAddress) {
            try {
                const response = await fetch(`http://localhost:3000/api/atomic-swap/?seller_address=${encodeURIComponent(walletAddress)}`);
                if (response.ok) {
                    const data = await response.json();
                    // Verificar se esta inscri√ß√£o tem listing ativa (OPEN ou PENDING_SIGNATURES)
                    listingInfo = data.listings?.find(l => 
                        l.inscription_id === inscriptionId && 
                        (l.status === 'OPEN' || l.status === 'PENDING_SIGNATURES')
                    );
                    isListed = !!listingInfo;
                }
            } catch (err) {
                console.warn('‚ö†Ô∏è Error checking listing status:', err);
            }
        }
        
        // Determinar como exibir baseado no content_type
        let contentHtml = '';
        const contentType = (inscription.content_type || 'unknown').toLowerCase();
        
        // Suporte COMPLETO para TODAS as extens√µes de imagem
        const imageExtensions = [
            'png', 'jpg', 'jpeg', 'gif', 'webp', 'avif', 'svg', 'bmp', 
            'ico', 'tiff', 'tif', 'heic', 'heif', 'jfif', 'pjpeg', 'pjp'
        ];
        
        // Verificar se √© imagem por tipo OU extens√£o
        const isImage = contentType.includes('image/') || 
                        imageExtensions.some(ext => inscriptionId.toLowerCase().includes(ext)) ||
                        contentType === 'unknown';
        
        // Suporte para v√≠deos
        const videoExtensions = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'mkv', 'm4v', '3gp'];
        const isVideo = contentType.includes('video/') || 
                        videoExtensions.some(ext => inscriptionId.toLowerCase().includes(ext));
        
        if (isImage && !isVideo) {
            // IMAGEM
            contentHtml = `<img src="${contentUrl}" alt="Inscription #${inscriptionNumber}" loading="lazy" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><rect width=%22200%22 height=%22200%22 fill=%22%23333%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23666%22 font-size=%2260%22>üìÑ</text></svg>'">`;
        } else if (isVideo) {
            // V√çDEO
            contentHtml = `<video src="${contentUrl}" controls muted loop autoplay playsinline></video>`;
        } else if (contentType.includes('text/') || contentType.includes('application/json')) {
            // Texto/JSON
            contentHtml = `<iframe src="${contentUrl}" sandbox="allow-same-origin allow-scripts" loading="lazy"></iframe>`;
        } else if (contentType.includes('audio/')) {
            // √Åudio
            contentHtml = `<div class="content-placeholder">üéµ<br>Audio<br><audio src="${contentUrl}" controls></audio></div>`;
        } else {
            // Padr√£o: tentar como imagem
            contentHtml = `<img src="${contentUrl}" alt="Inscription #${inscriptionNumber}" loading="lazy" onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><rect width=%22200%22 height=%22200%22 fill=%22%23333%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23666%22 font-size=%2260%22>üìÑ</text></svg>'">`;
        }
        
        // Truncar ID com seguran√ßa (MESMO ESTILO do Marketplace)
        const truncatedId = inscriptionId.length > 16 
            ? `${inscriptionId.slice(0, 12)}...${inscriptionId.slice(-4)}`
            : inscriptionId;
        
        // Verificar wallet type
        const walletType = localStorage.getItem('walletType');
        const isKrayWallet = walletType === 'kraywallet';
        
        console.log(`üé® Creating card for wallet type: ${walletType}`);
        console.log(`   Is Kray Wallet: ${isKrayWallet}`);
        console.log(`   Button color: ${isKrayWallet ? 'üü¢ GREEN (0% fee)' : 'üü† ORANGE (1% fee)'}`);
        
        // MESMA ESTRUTURA do Marketplace, mas com bot√£o espec√≠fico por wallet
        card.innerHTML = `
            <div class="ordinal-image">${contentHtml}</div>
            <div class="ordinal-info">
                <div class="ordinal-number">Inscription #${inscriptionNumber}</div>
                <div class="ordinal-id" title="${inscriptionId}">${truncatedId}</div>
                ${isListed ? `
                    <div style="
                        width: 100%;
                        padding: 8px 12px;
                        background: rgba(76, 175, 80, 0.1);
                        border: 1px solid #4CAF50;
                        border-radius: 8px;
                        margin-top: 10px;
                        text-align: center;
                    ">
                        <span style="color: #4CAF50; font-size: 12px; font-weight: 600;">
                            ‚úÖ Listed for ${listingInfo?.price_sats?.toLocaleString() || '...'} sats
                        </span>
                    </div>
                ` : `
                <div class="ordinal-price">
                    ${isKrayWallet ? `
                        <button class="btn btn-small btn-primary" style="width: 100%; background: #4CAF50; margin-top: 10px;" onclick="openListModal('${inscriptionId}', '${inscriptionNumber}')">
                                üìù List for Sale
                        </button>
                    ` : `
                        <button class="btn btn-small btn-primary" style="width: 100%; background: #FF9800; color: white; margin-top: 10px; border: none;" onclick="openOrdCliModal('${inscriptionId}', '${inscriptionNumber}')">
                            üìù List for Sale
                        </button>
                    `}
                </div>
                `}
            </div>
        `;
        
        return card;
    }
    
    // Criar listing (KrayWallet, Unisat, Xverse)
    async function createKrayWalletListing(inscriptionId, inscriptionNumber, price, description) {
        const walletType = localStorage.getItem('walletType');
        const walletAddress = localStorage.getItem('walletAddress');
        
        console.log(`üöÄ Creating listing with ${walletType}:`, {inscriptionId, price, description});
        console.log(`   Service fee: ${walletType === 'kraywallet' ? '0%' : '1%'}`);
        
        // ‚úÖ KRAY WALLET ‚Üí Usar extens√£o diretamente (0% fee)
        if (walletType === 'kraywallet') {
            if (!window.krayWallet) {
                throw new Error('Kray Wallet extension not found. Please install and connect Kray Wallet.');
            }
            
            try {
                console.log('üìû Calling Kray Wallet extension...');
                const result = await window.krayWallet.createOffer({
                    inscriptionId,
                    price,
                    description: description || null
                });
                
                console.log('‚úÖ PSBT created:', result);
                
                // üî• FECHAR O MODAL IMEDIATAMENTE
                const modal = document.getElementById('listModalOverlay');
                if (modal) {
                    modal.remove();
                    console.log('‚úÖ List modal closed');
                }
                
                // ‚úÖ PSBT criado com sucesso
                // O popup da Kray Wallet j√° ser√° aberto automaticamente pela extension
                console.log('‚úÖ PSBT created, wallet popup will open automatically');
                
                // Recarregar inscri√ß√µes ap√≥s alguns segundos para mostrar o status atualizado
                setTimeout(async () => {
                    console.log('üîÑ Reloading inscriptions...');
                    await loadWalletInscriptions();
                }, 2000);
                
            } catch (error) {
                console.error('‚ùå Error creating listing:', error);
                throw error;
            }
            return;
        }
        
        // ‚úÖ UNISAT, XVERSE ‚Üí Usar backend PSBT + assinar (ATOMIC SWAP com 2% fee)
        if (walletType === 'unisat' || walletType === 'xverse') {
            if (!walletAddress) {
                throw new Error('Wallet not connected. Please connect your wallet first.');
            }
            
            try {
                // üîç Step 1: Get inscription UTXO details
                console.log('üîç Fetching inscription details...');
                const inscriptionResponse = await fetch(`http://localhost:3000/api/inscriptions/${inscriptionId}`);
                
                if (!inscriptionResponse.ok) {
                    throw new Error('Failed to fetch inscription details');
                }
                
                const inscription = await inscriptionResponse.json();
                console.log('‚úÖ Inscription found:', {
                    txid: inscription.genesis_transaction,
                    vout: inscription.vout || 0,
                    value: inscription.value || 10000
                });
                
                // üì¶ Step 2: Create atomic swap listing (template PSBT)
                console.log('üì¶ Creating atomic swap listing...');
                const createResponse = await fetch('http://localhost:3000/api/atomic-swap/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        seller_txid: inscription.genesis_transaction,
                        seller_vout: inscription.vout || 0,
                        seller_value: inscription.value || 10000,
                        price_sats: price,
                        seller_payout_address: walletAddress
                    })
                });
                
                if (!createResponse.ok) {
                    const error = await createResponse.json();
                    throw new Error(error.error || 'Failed to create listing');
                }
                
                const listingData = await createResponse.json();
                console.log('‚úÖ Atomic swap listing created:', {
                    order_id: listingData.order_id,
                    status: 'PENDING_SIGNATURES'
                });
                
                // üñäÔ∏è Step 3: Sign PSBT with SIGHASH_SINGLE|ANYONECANPAY (0x83)
                console.log('üìù Opening wallet to sign with SIGHASH_SINGLE|ANYONECANPAY...');
                let signedPsbt;
                
                if (walletType === 'unisat' && window.unisat) {
                    console.log('   Unisat: signing...');
                    // Unisat: try with options if supported
                    try {
                        signedPsbt = await window.unisat.signPsbt(listingData.template_psbt_base64, {
                            autoFinalized: false,
                            toSignInputs: [{
                                index: 0,
                                sighashTypes: [0x83] // SIGHASH_SINGLE|ANYONECANPAY
                            }]
                        });
                    } catch (e) {
                        // Fallback: sign normally (Unisat may not support custom sighash)
                        console.warn('‚ö†Ô∏è Unisat may not support custom SIGHASH, trying default...');
                        signedPsbt = await window.unisat.signPsbt(listingData.template_psbt_base64);
                    }
                } else if (walletType === 'xverse' && window.XverseProviders) {
                    console.log('   Xverse: signing...');
                    const response = await window.XverseProviders.BitcoinProvider.request('signPsbt', {
                        psbt: listingData.template_psbt_base64,
                        broadcast: false,
                        inputsToSign: [{
                            address: walletAddress,
                            signingIndexes: [0],
                            sigHash: 0x83 // SIGHASH_SINGLE|ANYONECANPAY
                        }]
                    });
                    signedPsbt = response.psbt;
                } else {
                    throw new Error(`${walletType} wallet not found`);
                }
                
                console.log('‚úÖ PSBT signed, publishing listing...');
                
                // üì§ Step 4: Send signed PSBT to backend (atomic swap seller signature)
                const publishResponse = await fetch(`http://localhost:3000/api/atomic-swap/${listingData.order_id}/seller-signature`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        listing_psbt_base64: signedPsbt
                    })
                });
                
                if (!publishResponse.ok) {
                    const error = await publishResponse.json();
                    throw new Error(error.error || 'Failed to publish listing');
                }
                
                const publishResult = await publishResponse.json();
                console.log('‚úÖ Atomic swap listing published!', publishResult);
                
                // Calculate fees (2%)
                const marketFee = Math.max(Math.floor(price * 0.02), 546); // 2% with 546 sats minimum
                alert(`‚úÖ Atomic Swap listing created! (2% marketplace fee)\n\nInscription #${inscriptionNumber}\nPrice: ${price.toLocaleString()} sats\nMarketplace fee (paid by buyer): ${marketFee.toLocaleString()} sats\nYou receive: ${price.toLocaleString()} sats\n\nStatus: ${publishResult.status}\nOrder ID: ${publishResult.order_id}\n\nYour inscription is now listed for sale!`);
                await loadWalletInscriptions();
                
            } catch (error) {
                console.error('‚ùå Error creating atomic swap listing:', error);
                throw error;
            }
            return;
        }
        
        // Wallet n√£o suportada
        throw new Error(`Unsupported wallet: ${walletType}.\n\nPlease use Kray Wallet, Unisat, or Xverse.`);
    }
    
    // Open ORD CLI modal (para outras wallets - 1% fee)
    window.openOrdCliModal = function(inscriptionId, inscriptionNumber) {
        console.log('‚ö° Opening list modal for:', inscriptionId);
        
        const walletType = localStorage.getItem('walletType') || 'unknown';
        
        // ‚ö†Ô∏è SE FOR UNISAT, XVERSE, LEATHER ‚Üí BLOQUEAR (eles n√£o suportam SIGHASH_SINGLE|ANYONECANPAY)
        if (walletType === 'unisat' || walletType === 'xverse' || walletType === 'leather') {
            console.log(`‚ö†Ô∏è ${walletType} detected - BLOCKING listing (SIGHASH_ALL limitation)`);
            
            // Show educational modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
                    border: 2px solid #ff6b00;
                    border-radius: 16px;
                    padding: 40px;
                    max-width: 600px;
                    text-align: center;
                    box-shadow: 0 20px 60px rgba(255, 107, 0, 0.3);
                ">
                    <div style="font-size: 64px; margin-bottom: 20px;">üîê</div>
                    <h2 style="color: #ffffff; margin-bottom: 20px; font-size: 28px;">
                        Atomic Swaps: Kray Wallet Exclusive
                    </h2>
                    
                    <div style="background: rgba(255, 107, 0, 0.1); border-left: 4px solid #ff6b00; padding: 20px; margin: 20px 0; text-align: left;">
                        <p style="color: #ffffff; margin: 0; line-height: 1.8;">
                            <strong style="color: #ff6b00;">Why this limitation?</strong><br>
                            ${walletType.charAt(0).toUpperCase() + walletType.slice(1)} wallet signs with <code style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px;">SIGHASH_ALL</code>, which locks the entire transaction and prevents atomic swaps.
                        </p>
                    </div>
                    
                    <div style="background: rgba(0, 255, 0, 0.05); border-left: 4px solid #00ff00; padding: 20px; margin: 20px 0; text-align: left;">
                        <p style="color: #ffffff; margin: 0; line-height: 1.8;">
                            <strong style="color: #00ff00;">Kray Wallet Solution:</strong><br>
                            Kray Wallet uses <code style="background: rgba(255,255,255,0.1); padding: 2px 8px; border-radius: 4px;">SIGHASH_SINGLE|ANYONECANPAY</code>, enabling true atomic swaps - instant, secure, and trustless.
                        </p>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <p style="color: #aaaaaa; margin-bottom: 20px;">
                            ‚úÖ You can still <strong>BUY</strong> inscriptions with ${walletType.charAt(0).toUpperCase() + walletType.slice(1)}<br>
                            üìù To <strong>SELL</strong>, please use Kray Wallet
                        </p>
                        
                        <button onclick="this.closest('div').parentElement.remove()" style="
                            background: linear-gradient(135deg, #ff6b00 0%, #ff8533 100%);
                            color: white;
                            border: none;
                            padding: 15px 40px;
                            border-radius: 8px;
                            font-size: 16px;
                            font-weight: bold;
                            cursor: pointer;
                            transition: transform 0.2s;
                            box-shadow: 0 4px 15px rgba(255, 107, 0, 0.4);
                        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            Got it! üëç
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            return;
        }
        
        // Se n√£o tiver wallet conectada ou for desconhecida ‚Üí Mostrar ORD CLI
        console.log('‚ö†Ô∏è No wallet detected - showing ORD CLI instructions');
        
        // Criar modal overlay
        const overlay = document.createElement('div');
        overlay.id = 'ordCliModalOverlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        `;
        
        // Criar modal
        const modal = document.createElement('div');
        modal.style.cssText = `
            background: var(--color-bg-secondary);
            border: 1px solid #FF9800;
            border-radius: var(--radius-lg);
            padding: var(--spacing-3xl);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        `;
        
        modal.innerHTML = `
            <div style="margin-bottom: var(--spacing-2xl); padding-bottom: var(--spacing-2xl); border-bottom: 1px solid var(--color-border);">
                <div style="display: flex; align-items: center; gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #FF6B00 0%, #FF8C00 100%); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; font-size: 24px;">
                        ‚ö°
                    </div>
                    <div>
                        <h2 style="margin: 0; color: var(--color-text-primary); font-size: 24px; font-weight: 600; letter-spacing: -0.5px;">
                            List for Sale
                        </h2>
                        <p style="margin: 0; color: var(--color-text-secondary); font-size: 12px;">
                            Via ORD CLI ‚Ä¢ 1% Service Fee
                        </p>
                    </div>
                </div>
                <p style="margin: 0; color: var(--color-text-secondary); font-size: 14px;">
                    Inscription #${inscriptionNumber}
                </p>
            </div>
            
            <div style="background: rgba(255, 152, 0, 0.1); border-left: 2px solid #FF9800; padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-2xl);">
                <p style="margin: 0; color: var(--color-text-secondary); font-size: 13px; line-height: 1.6;">
                    <strong style="color: #FF9800;">${walletType} wallet detected.</strong> Set your price and we'll generate a command to list your inscription. Just copy and paste it in your terminal!
                </p>
            </div>
            
            <div style="margin-bottom: var(--spacing-2xl);">
                <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--color-text-primary); font-weight: 500; font-size: 14px;">
                    Inscription ID
                </label>
                <input 
                    type="text" 
                    id="ordCliInscriptionId" 
                    value="${inscriptionId}"
                    readonly
                    style="width: 100%; background: var(--color-bg-card); border: 1px solid var(--color-border); font-size: 13px; padding: 12px 16px; border-radius: var(--radius-md); color: var(--color-text-secondary); font-family: var(--font-mono); opacity: 0.7;"
                >
            </div>
            
            <div style="margin-bottom: var(--spacing-3xl);">
                <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--color-text-primary); font-weight: 500; font-size: 14px;">
                    Price (sats) *
                </label>
                <input 
                    type="number" 
                    id="ordCliPrice" 
                    placeholder="e.g. 50000"
                    min="1000"
                    style="width: 100%; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); font-size: 16px; padding: 14px 16px; border-radius: var(--radius-md); color: var(--color-text-primary); font-family: var(--font-mono); transition: all var(--transition-base);"
                    onfocus="this.style.borderColor='#FF9800'" 
                    onblur="this.style.borderColor='var(--color-border)'"
                >
                <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--spacing-xs); font-size: 12px;">
                    Minimum: 1,000 sats ‚Ä¢ You will receive 99% (1% fee)
                </small>
            </div>
            
            <div style="display: flex; gap: var(--spacing-md);">
                <button 
                    id="cancelOrdCliBtn"
                    style="flex: 1; padding: 14px; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text-primary); font-weight: 600; cursor: pointer; font-size: 14px; transition: all var(--transition-base);"
                    onmouseover="this.style.borderColor='var(--color-text-primary)'" 
                    onmouseout="this.style.borderColor='var(--color-border)'"
                >
                    Cancel
                </button>
                <button 
                    id="generateOrdCliBtn"
                    style="flex: 1; padding: 14px; background: linear-gradient(135deg, #FF6B00 0%, #FF8C00 100%); border: none; border-radius: var(--radius-md); color: white; font-weight: 600; cursor: pointer; font-size: 14px; transition: all var(--transition-base); box-shadow: 0 4px 12px rgba(255, 107, 0, 0.3);"
                    onmouseover="this.style.opacity='0.9'" 
                    onmouseout="this.style.opacity='1'"
                >
                    üìù Create Listing
                </button>
            </div>
            
            <!-- Command display (hidden initially) -->
            <div id="ordCliCommandDisplay" style="display: none; margin-top: var(--spacing-3xl); padding-top: var(--spacing-3xl); border-top: 1px solid var(--color-border);">
                <h3 style="margin: 0 0 var(--spacing-lg) 0; color: #FF9800; font-size: 16px; font-weight: 600;">
                    üìã Your Listing Command
                </h3>
                
                <div style="background: var(--color-bg-card); border: 1px solid var(--color-border); border-radius: var(--radius-md); padding: var(--spacing-lg); margin-bottom: var(--spacing-lg); position: relative;">
                    <code id="ordCliCommandText" style="display: block; color: #4CAF50; font-family: var(--font-mono); font-size: 13px; line-height: 1.6; white-space: pre-wrap; word-break: break-all;"></code>
                    <button 
                        id="copyOrdCliCommandBtn"
                        style="position: absolute; top: var(--spacing-sm); right: var(--spacing-sm); background: #FF9800; border: none; padding: 8px 16px; border-radius: var(--radius-sm); color: white; cursor: pointer; font-size: 12px; font-weight: 600; transition: all var(--transition-base);"
                        onmouseover="this.style.opacity='0.9'" 
                        onmouseout="this.style.opacity='1'"
                    >
                        üìã Copy
                    </button>
                </div>
                
                <div style="background: var(--color-bg-secondary); border-left: 2px solid var(--color-text-primary); padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
                    <h4 style="margin: 0 0 var(--spacing-md) 0; color: var(--color-text-primary); font-size: 14px; font-weight: 600;">
                        Next Steps
                    </h4>
                    <ol style="margin: 0; padding-left: 20px; color: var(--color-text-secondary); font-size: 13px; line-height: 1.8;">
                        <li>Copy the command above</li>
                        <li>Open your terminal</li>
                        <li>Make sure ORD CLI and Bitcoin Core are running</li>
                        <li>Paste and execute the command</li>
                        <li>Your offer will appear on Kray Station in ~5 minutes</li>
                    </ol>
                </div>
                
                <div style="background: rgba(255, 152, 0, 0.1); border-left: 2px solid #FF9800; padding: var(--spacing-lg); border-radius: var(--radius-md);">
                    <h4 style="margin: 0 0 var(--spacing-md) 0; color: #FF9800; font-size: 14px; font-weight: 600;">
                        üí∞ Fee Breakdown
                    </h4>
                    <div style="color: var(--color-text-secondary); font-size: 13px;">
                        <div style="display: flex; justify-content: space-between; margin: var(--spacing-xs) 0;">
                            <span>Your offer price:</span>
                            <span id="ordFeePrice" style="color: var(--color-text-primary); font-weight: 600; font-family: var(--font-mono);">0 sats</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: var(--spacing-xs) 0;">
                            <span>Service fee (1%):</span>
                            <span id="ordFeeService" style="color: #FF9800; font-weight: 600; font-family: var(--font-mono);">0 sats</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin: var(--spacing-xs) 0; padding-top: var(--spacing-sm); border-top: 1px solid var(--color-border);">
                            <span style="font-weight: 600; color: var(--color-text-primary);">You receive:</span>
                            <span id="ordFeeReceive" style="color: var(--color-text-primary); font-weight: 700; font-size: 15px; font-family: var(--font-mono);">0 sats</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // Focus no input de pre√ßo
        setTimeout(() => {
            modal.querySelector('#ordCliPrice').focus();
        }, 100);
        
        // Bot√£o Cancel
        modal.querySelector('#cancelOrdCliBtn').addEventListener('click', () => {
            overlay.remove();
        });
        
        // Fechar ao clicar fora
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.remove();
            }
        });
        
        // ESC para fechar
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                overlay.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
        
        // Bot√£o Generate - GERA COMANDO PARA EXECUTAR LOCALMENTE
        modal.querySelector('#generateOrdCliBtn').addEventListener('click', () => {
            console.log('üîò Generate button clicked!');
            const priceInput = modal.querySelector('#ordCliPrice');
            const price = parseInt(priceInput.value);
            
            console.log('üìä Price input value:', priceInput.value);
            console.log('üìä Parsed price:', price);
            
            if (!price || price < 1000) {
                console.log('‚ùå Price validation failed');
                alert('Please enter a valid price (minimum 1,000 sats)');
                return;
            }
            
            console.log('‚úÖ Price validated, generating command...');
            
            // Calcular fees
            const serviceFee = Math.floor(price * 0.01); // 1%
            const youReceive = price - serviceFee;
            
            // Gerar comando ORD CLI
            const command = `ord wallet offer create ${inscriptionId} ${youReceive}`;
            
            // Mostrar comando
            modal.querySelector('#ordCliCommandText').textContent = command;
            modal.querySelector('#ordFeePrice').textContent = `${price.toLocaleString()} sats`;
            modal.querySelector('#ordFeeService').textContent = `${serviceFee.toLocaleString()} sats`;
            modal.querySelector('#ordFeeReceive').textContent = `${youReceive.toLocaleString()} sats`;
            
            // Atualizar instru√ß√µes para incluir o pr√≥ximo passo (submit PSBT)
            const nextStepsDiv = modal.querySelector('#ordCliCommandDisplay');
            const existingSteps = nextStepsDiv.querySelector('.next-steps');
            if (existingSteps) {
                existingSteps.innerHTML = `
                    <h4 style="margin: 0 0 var(--spacing-md) 0; color: var(--color-text-primary); font-size: 14px; font-weight: 600;">
                        üìã Next Steps
                    </h4>
                    <ol style="margin: 0; padding-left: 20px; color: var(--color-text-secondary); font-size: 13px; line-height: 1.8;">
                        <li>Copy the command above</li>
                        <li>Open your terminal</li>
                        <li>Make sure ORD CLI and Bitcoin Core are running</li>
                        <li>Paste and execute the command</li>
                        <li><strong style="color: #FF9800;">Copy the PSBT output from the terminal</strong></li>
                        <li><strong style="color: #FF9800;">Click "Submit PSBT" below to publish your offer</strong></li>
                    </ol>
                `;
            }
            
            // Adicionar bot√£o "Submit PSBT" se n√£o existir
            let submitButton = modal.querySelector('#submitPsbtBtn');
            if (!submitButton) {
                submitButton = document.createElement('button');
                submitButton.id = 'submitPsbtBtn';
                submitButton.style.cssText = `
                    width: 100%;
                    padding: 14px;
                    background: #4CAF50;
                    border: none;
                    border-radius: var(--radius-md);
                    color: white;
                    font-weight: 600;
                    cursor: pointer;
                    font-size: 14px;
                    margin-top: var(--spacing-lg);
                    transition: all var(--transition-base);
                `;
                submitButton.textContent = 'üì§ Submit PSBT to Marketplace';
                submitButton.onclick = async () => {
                    const psbt = prompt('üìã Paste the PSBT from your terminal:\n\n(Should start with "cHNidP8" or "70736274")');
                    if (!psbt) {
                        console.log('‚ùå User cancelled PSBT input');
                        return;
                    }
                    
                    // Limpar espa√ßos em branco
                    const psbtTrimmed = psbt.trim();
                    
                    // Validar formato b√°sico
                    if (!psbtTrimmed.startsWith('cHNidP8') && !psbtTrimmed.startsWith('70736274')) {
                        alert('‚ùå Invalid PSBT format!\n\nPSBT should start with "cHNidP8" (base64) or "70736274" (hex).\n\nPlease copy the PSBT output from your terminal after running:\nord wallet offer create ...');
                        return;
                    }
                    
                    console.log('‚úÖ PSBT format looks valid, submitting...');
                    console.log('   Length:', psbtTrimmed.length, 'chars');
                    console.log('   Starts with:', psbtTrimmed.substring(0, 20));
                    
                    submitButton.disabled = true;
                    submitButton.textContent = '‚è≥ Publishing...';
                    submitButton.style.opacity = '0.6';
                    
                    try {
                        const response = await fetch('http://localhost:3000/api/ord-offers/submit-psbt', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                psbt: psbtTrimmed,
                                inscriptionId,
                                price
                            })
                        });
                        
                        const result = await response.json();
                        
                        if (!response.ok) {
                            throw new Error(result.error || 'Failed to submit PSBT');
                        }
                        
                        overlay.remove();
                        alert(`üéâ Offer published successfully!\n\nYour inscription is now live on the marketplace!`);
                        
                        if (typeof loadOrdinals === 'function') {
                            await loadOrdinals();
                        }
                    } catch (error) {
                        alert(`‚ùå Error: ${error.message}`);
                        submitButton.disabled = false;
                        submitButton.textContent = 'üì§ Submit PSBT to Marketplace';
                        submitButton.style.opacity = '1';
                    }
                };
                
                nextStepsDiv.appendChild(submitButton);
            }
            
            // Mostrar se√ß√£o de comando
            modal.querySelector('#ordCliCommandDisplay').style.display = 'block';
            
            // Scroll para o comando
            setTimeout(() => {
                modal.querySelector('#ordCliCommandDisplay').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        });
        
        // Bot√£o Copy
        modal.querySelector('#copyOrdCliCommandBtn').addEventListener('click', () => {
            const commandText = modal.querySelector('#ordCliCommandText').textContent;
            navigator.clipboard.writeText(commandText).then(() => {
                const btn = modal.querySelector('#copyOrdCliCommandBtn');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Copied!';
                btn.style.background = '#4CAF50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#FF9800';
                }, 2000);
            });
        });
    };
    
    // Open modal to list inscription (KRAY WALLET ONLY)
    window.openListModal = function(inscriptionId, inscriptionNumber) {
        console.log('üìù Opening list modal for:', inscriptionId);
        
        // Criar modal overlay
        const overlay = document.createElement('div');
        overlay.id = 'listModalOverlay';
        overlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(10px);
        `;
        
        // Criar modal
        const modal = document.createElement('div');
        modal.style.cssText = `
            background: var(--color-bg-secondary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-lg);
            padding: var(--spacing-3xl);
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        `;
        
        modal.innerHTML = `
            <div style="margin-bottom: var(--spacing-2xl); padding-bottom: var(--spacing-2xl); border-bottom: 1px solid var(--color-border);">
                <h2 style="margin: 0 0 var(--spacing-sm) 0; color: var(--color-text-primary); font-size: 24px; font-weight: 600; letter-spacing: -0.5px;">
                    List for Sale
                </h2>
                <p style="margin: 0; color: var(--color-text-secondary); font-size: 14px;">
                    Inscription #${inscriptionNumber}
                </p>
            </div>
            
            <div style="margin-bottom: var(--spacing-2xl);">
                <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--color-text-primary); font-weight: 500; font-size: 14px;">
                    Price (sats) *
                </label>
                <input 
                    type="number" 
                    id="listPrice" 
                    placeholder="e.g. 50000"
                    min="1000"
                    style="width: 100%; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); font-size: 16px; padding: 14px 16px; border-radius: var(--radius-md); color: var(--color-text-primary); font-family: var(--font-mono); transition: all var(--transition-base);"
                    onfocus="this.style.borderColor='var(--color-text-primary)'" 
                    onblur="this.style.borderColor='var(--color-border)'"
                >
                <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--spacing-xs); font-size: 12px;">
                    Minimum: 1,000 sats
                </small>
            </div>
            
            <div style="margin-bottom: var(--spacing-3xl);">
                <label style="display: block; margin-bottom: var(--spacing-sm); color: var(--color-text-primary); font-weight: 500; font-size: 14px;">
                    Description (optional)
                </label>
                <textarea 
                    id="listDescription" 
                    placeholder="Tell the story of this inscription..."
                    rows="4"
                    maxlength="500"
                    style="width: 100%; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); font-size: 14px; padding: 14px 16px; border-radius: var(--radius-md); color: var(--color-text-primary); resize: vertical; font-family: inherit; transition: all var(--transition-base);"
                    onfocus="this.style.borderColor='var(--color-text-primary)'" 
                    onblur="this.style.borderColor='var(--color-border)'"
                ></textarea>
                <small style="color: var(--color-text-tertiary); display: block; margin-top: var(--spacing-xs); font-size: 12px;">
                    <span id="charCount">0</span>/500 characters
                </small>
            </div>
            
            <div style="display: flex; gap: var(--spacing-md);">
                <button 
                    id="cancelListBtn"
                    style="flex: 1; padding: 14px; background: var(--color-bg-tertiary); border: 1px solid var(--color-border); border-radius: var(--radius-md); color: var(--color-text-primary); font-weight: 600; cursor: pointer; font-size: 14px; transition: all var(--transition-base);"
                    onmouseover="this.style.borderColor='var(--color-text-primary)'" 
                    onmouseout="this.style.borderColor='var(--color-border)'"
                >
                    Cancel
                </button>
                <button 
                    id="confirmListBtn"
                    style="flex: 1; padding: 14px; background: var(--color-text-primary); border: none; border-radius: var(--radius-md); color: var(--color-bg-primary); font-weight: 600; cursor: pointer; font-size: 14px; transition: all var(--transition-base);"
                    onmouseover="this.style.opacity='0.9'" 
                    onmouseout="this.style.opacity='1'"
                >
                    Create Listing
                </button>
            </div>
        `;
        
        overlay.appendChild(modal);
        document.body.appendChild(overlay);
        
        // Character counter
        const descInput = modal.querySelector('#listDescription');
        const charCount = modal.querySelector('#charCount');
        descInput.addEventListener('input', () => {
            charCount.textContent = descInput.value.length;
        });
        
        // Focus no input de pre√ßo
        setTimeout(() => {
            modal.querySelector('#listPrice').focus();
        }, 100);
        
        // Bot√£o Cancel
        modal.querySelector('#cancelListBtn').addEventListener('click', () => {
            overlay.remove();
        });
        
        // Fechar ao clicar fora
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) {
                overlay.remove();
            }
        });
        
        // ESC para fechar
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                overlay.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
        
        // Bot√£o Confirm
        modal.querySelector('#confirmListBtn').addEventListener('click', async () => {
            const price = parseInt(modal.querySelector('#listPrice').value);
            const description = modal.querySelector('#listDescription').value.trim();
            
            if (!price || price < 1000) {
                alert('Please enter a valid price (minimum 1,000 sats)');
                return;
            }
            
            // Criar listing via Kray Wallet extension
            try {
                const confirmBtn = modal.querySelector('#confirmListBtn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Creating...';
                confirmBtn.style.opacity = '0.7';
                
                await createKrayWalletListing(inscriptionId, inscriptionNumber, price, description);
                
                overlay.remove();
            } catch (error) {
                console.error('‚ùå Error creating listing:', error);
                alert('Error creating listing: ' + error.message);
                
                const confirmBtn = modal.querySelector('#confirmListBtn');
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Create Listing';
                confirmBtn.style.opacity = '1';
            }
        });
    };
    
    // ‚úÖ EVENT LISTENERS para Search e Filtros (Create Offer)
    document.getElementById('searchMyInscriptions')?.addEventListener('input', filterAndSortMyInscriptions);
    document.getElementById('sortMyInscriptions')?.addEventListener('change', filterAndSortMyInscriptions);
    
    // ‚úÖ EVENT LISTENERS para Pagina√ß√£o (Create Offer)
    document.getElementById('createPrevBtn')?.addEventListener('click', () => {
        if (currentCreatePage > 1) {
            currentCreatePage--;
            renderMyInscriptions(window.myInscriptionsFiltered || window.myInscriptions);
        }
    });
    
    document.getElementById('createNextBtn')?.addEventListener('click', () => {
        const totalPages = Math.ceil((window.myInscriptionsFiltered || window.myInscriptions).length / itemsPerPage);
        if (currentCreatePage < totalPages) {
            currentCreatePage++;
            renderMyInscriptions(window.myInscriptionsFiltered || window.myInscriptions);
        }
    });
    
    // ‚úÖ CHAMAR AUTOMATICAMENTE quando p√°gina carregar SE j√° tiver wallet conectada
    console.log('üéØ Checking if wallet is already connected on page load...');
    setTimeout(() => {
        const walletType = localStorage.getItem('walletType');
        if (walletType) {
            console.log(`‚úÖ Wallet detected on load: ${walletType}`);
            console.log('üìû Calling loadWalletInscriptions() automatically...');
            loadWalletInscriptions();
        } else {
            console.log('‚ÑπÔ∏è  No wallet connected on page load');
        }
    }, 500);
    
    // Detect when "Create Offer" tab becomes active
    console.log('üéØ Setting up Create Offer tab observer...');
    const createOfferContent = document.getElementById('create-offer');
    
    if (createOfferContent) {
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                    const hasActiveClass = createOfferContent.classList.contains('active');
                    
                    if (hasActiveClass) {
                        console.log('‚úÖ CREATE OFFER TAB IS NOW ACTIVE! Calling loadWalletInscriptions...');
                        loadWalletInscriptions();
                    }
                }
            });
        });
        
        observer.observe(createOfferContent, {
            attributes: true,
            attributeFilter: ['class']
        });
        
        console.log('‚úÖ MutationObserver set up successfully!');
    }
    
    // üîî Show visual prompt to click Kray Wallet extension
    // üîî Extension prompt removed - popup opens automatically
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üõçÔ∏è ATOMIC SWAP MARKETPLACE - LOAD LISTINGS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function loadAtomicSwapListings() {
        console.log('üîç Loading atomic swap listings...');
        console.log('   üìç Function called from:', new Error().stack);
        
        try {
            const response = await fetch('http://localhost:3000/api/atomic-swap/');
            console.log('   üì° API Response status:', response.status);
            
            if (!response.ok) {
                throw new Error('Failed to fetch listings');
            }
            
            const data = await response.json();
            const listings = data.listings || [];
            
            console.log(`‚úÖ Loaded ${listings.length} atomic swap listings`);
            console.log('   üìã Listings data:', listings);
            
            const grid = document.getElementById('marketplaceGrid');
            console.log('   üéØ Grid element:', grid ? 'FOUND ‚úÖ' : 'NOT FOUND ‚ùå');
            
            if (!grid) {
                console.error('‚ùå marketplaceGrid element not found!');
                console.log('   üîç Available elements with "Grid" in id:');
                document.querySelectorAll('[id*="Grid"]').forEach(el => {
                    console.log('      -', el.id, el);
                });
                return;
            }
            
            console.log('   üßπ Clearing grid...');
            grid.innerHTML = '';
            
            if (listings.length === 0) {
                console.log('   ‚ö†Ô∏è No listings, showing empty state');
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; grid-column: 1 / -1;">
                        <div style="font-size: 60px; margin-bottom: 20px;">üèúÔ∏è</div>
                        <h3 style="color: var(--color-text-primary); margin-bottom: 10px;">No listings yet</h3>
                        <p style="color: var(--color-text-secondary);">Be the first to list an inscription!</p>
                    </div>
                `;
                return;
            }
            
            // Render cada listagem
            console.log(`   üé® Rendering ${listings.length} cards...`);
            for (let i = 0; i < listings.length; i++) {
                const listing = listings[i];
                console.log(`      [${i+1}/${listings.length}] Creating card for:`, listing.inscription_id);
                const card = await createMarketplaceListingCard(listing);
                console.log(`      [${i+1}/${listings.length}] Card created, appending to grid`);
                grid.appendChild(card);
            }
            console.log('   ‚úÖ All cards rendered!');
            
        } catch (error) {
            console.error('‚ùå Error loading atomic swap listings:', error);
            const grid = document.getElementById('marketplaceGrid');
            if (grid) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; grid-column: 1 / -1;">
                        <div style="font-size: 60px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h3 style="color: var(--color-text-primary); margin-bottom: 10px;">Error loading listings</h3>
                        <p style="color: var(--color-text-secondary);">${error.message}</p>
                    </div>
                `;
            }
        }
    }
    
    // üìã LOAD MY LISTINGS (com bot√µes Cancel e Update Price)
    async function loadMyListings() {
        console.log('üîç Loading my listings...');
        
        const walletAddress = localStorage.getItem('walletAddress');
        
        const grid = document.getElementById('myOffersGrid');
        if (!grid) {
            console.error('‚ùå myOffersGrid element not found!');
            return;
        }
        
        if (!walletAddress) {
            console.warn('‚ö†Ô∏è No wallet connected');
            grid.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; grid-column: 1 / -1;">
                    <div style="font-size: 60px; margin-bottom: 20px;">üîí</div>
                    <h3 style="color: var(--color-text-primary); margin-bottom: 10px;">Connect Wallet</h3>
                    <p style="color: var(--color-text-secondary);">Connect your wallet to see your listings</p>
                </div>
            `;
            return;
        }
        
        try {
            const response = await fetch(`http://localhost:3000/api/atomic-swap/?seller_address=${encodeURIComponent(walletAddress)}`);
            
            if (!response.ok) {
                throw new Error('Failed to fetch my listings');
            }
            
            const data = await response.json();
            const allListings = data.listings || [];
            
            // üî• FILTRAR: Mostrar APENAS listings ATIVAS (OPEN ou PENDING_SIGNATURES)
            // N√ÉO mostrar CANCELLED, FILLED, ou EXPIRED
            const listings = allListings.filter(l => 
                l.status === 'OPEN' || l.status === 'PENDING_SIGNATURES'
            );
            
            console.log(`‚úÖ Loaded ${allListings.length} total listings, showing ${listings.length} active`);
            
            grid.innerHTML = '';
            
            if (listings.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; grid-column: 1 / -1;">
                        <div style="font-size: 60px; margin-bottom: 20px;">üìù</div>
                        <h3 style="color: var(--color-text-primary); margin-bottom: 10px;">No active listings</h3>
                        <p style="color: var(--color-text-secondary);">Go to "Create Offer" to list your inscriptions</p>
                    </div>
                `;
                return;
            }
            
            // Render cada listagem COM bot√µes de gerenciamento
            for (const listing of listings) {
                const card = await createMyListingCard(listing);
                grid.appendChild(card);
            }
            
        } catch (error) {
            console.error('‚ùå Error loading my listings:', error);
            grid.innerHTML = `
                <div style="text-align: center; padding: 60px 20px; grid-column: 1 / -1;">
                    <div style="font-size: 60px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h3 style="color: var(--color-text-primary); margin-bottom: 10px;">Error loading listings</h3>
                    <p style="color: var(--color-text-secondary);">${error.message}</p>
                </div>
            `;
        }
    }
    
    // üÉè CREATE MY LISTING CARD (com bot√µes Cancel e Update Price)
    async function createMyListingCard(listing) {
        const card = document.createElement('div');
        card.className = 'ordinal-card';
        
        // Badge de status
        const statusColors = {
            'PENDING_SIGNATURES': '#FFA500',
            'OPEN': '#10B981',
            'FILLED': '#6B7280',
            'CANCELLED': '#EF4444',
            'EXPIRED': '#6B7280'
        };
        
        const statusLabels = {
            'PENDING_SIGNATURES': '‚è≥ Pending Signature',
            'OPEN': '‚úÖ Active',
            'FILLED': '‚úîÔ∏è Sold',
            'CANCELLED': '‚ùå Cancelled',
            'EXPIRED': '‚åõ Expired'
        };
        
        const statusColor = statusColors[listing.status] || '#6B7280';
        const statusLabel = statusLabels[listing.status] || listing.status;
        
        // Calcular taxa
        const marketFee = Math.max(Math.floor(listing.price_sats * 0.02), 546);
        const totalCost = listing.price_sats + marketFee;
        
        card.innerHTML = `
            <div class="ordinal-image-container" style="position: relative;">
                <img src="http://localhost:3000/api/ordinals/${listing.inscription_id || listing.seller_txid + 'i' + listing.seller_vout}/content" 
                     alt="Inscription #${listing.inscription_number || '?'}"
                     class="ordinal-image"
                     loading="lazy"
                     onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 100 100%27%3E%3Crect fill=%27%23333%27 width=%27100%27 height=%27100%27/%3E%3Ctext x=%2750%25%27 y=%2750%25%27 text-anchor=%27middle%27 dy=%27.3em%27 fill=%27%23666%27 font-size=%2714%27%3E%23${listing.inscription_number || '?'}%3C/text%3E%3C/svg%3E';">
                
                <div style="position: absolute; top: 10px; right: 10px; background: ${statusColor}; color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600;">
                    ${statusLabel}
                </div>
            </div>
            
            <div class="ordinal-info">
                <div class="ordinal-number">Inscription #${listing.inscription_number || '?'}</div>
                
                <div style="margin: 12px 0; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="color: var(--color-text-secondary); font-size: 13px;">Price</span>
                        <span style="color: var(--color-text-primary); font-weight: 600;">${listing.price_sats.toLocaleString()} sats</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                        <span style="color: var(--color-text-secondary); font-size: 13px;">Market Fee (2%)</span>
                        <span style="color: var(--color-text-secondary); font-size: 13px;">${marketFee.toLocaleString()} sats</span>
                    </div>
                    <div style="border-top: 1px solid rgba(255,255,255,0.1); margin: 6px 0; padding-top: 6px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--color-text-primary); font-weight: 600;">Total (Buyer)</span>
                            <span style="color: var(--color-primary); font-weight: 700;">${totalCost.toLocaleString()} sats</span>
                        </div>
                    </div>
                </div>
                
                <div style="font-size: 11px; color: var(--color-text-secondary); margin: 8px 0;">
                    üìÖ Listed ${new Date(listing.created_at * 1000).toLocaleDateString()}
                </div>
                
                ${createListingActionButtons(listing)}
            </div>
        `;
        
        return card;
    }
    
    // üîò CREATE ACTION BUTTONS (Cancel e Update Price)
    function createListingActionButtons(listing) {
        const canCancel = ['PENDING_SIGNATURES', 'OPEN'].includes(listing.status);
        const canUpdatePrice = listing.status === 'PENDING_SIGNATURES';
        
        if (!canCancel && !canUpdatePrice) {
            return ''; // Nenhum bot√£o se j√° vendido ou cancelado
        }
        
        let buttons = '<div style="display: flex; gap: 8px; margin-top: 12px;">';
        
        if (canUpdatePrice) {
            buttons += `
                <button onclick="openUpdatePriceModal('${listing.order_id}', ${listing.price_sats})" 
                        style="flex: 1; padding: 10px; background: var(--color-primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                    üí∞ Update Price
                </button>
            `;
        }
        
        if (canCancel) {
            buttons += `
                <button onclick="cancelMyListing('${listing.order_id}')" 
                        style="flex: 1; padding: 10px; background: #EF4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 13px;">
                    ‚ùå Cancel
                </button>
            `;
        }
        
        buttons += '</div>';
        
        return buttons;
    }
    
    // ‚ùå CANCEL MY LISTING (COM ASSINATURA - SEM CONFIRM)
    async function cancelMyListing(orderId) {
        try {
            showNotification('üîê Sign message to cancel listing...', 'info');
            const walletType = localStorage.getItem('walletType');
            
            if (walletType !== 'kraywallet') {
                alert('Please connect Kray Wallet to manage listings');
                return;
            }
            
            const response = await window.krayWallet.cancelListing({ orderId });
            
            if (response.success) {
                alert('‚úÖ Listing cancelled successfully!');
                loadMyListings(); // Reload
            }
        } catch (error) {
            console.error('Error cancelling listing:', error);
            alert('Error: ' + error.message);
        }
    }
    
    // üí∞ OPEN UPDATE PRICE MODAL
    function openUpdatePriceModal(orderId, currentPrice) {
        const modal = document.createElement('div');
        modal.id = 'updatePriceModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
        
        modal.innerHTML = `
            <div style="background: var(--color-bg-secondary); padding: 30px; border-radius: 16px; max-width: 400px; width: 90%;">
                <h3 style="color: var(--color-text-primary); margin-bottom: 20px;">üí∞ Update Price</h3>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; color: var(--color-text-secondary); font-size: 13px; margin-bottom: 6px;">Current Price</label>
                    <div style="padding: 12px; background: rgba(255,255,255,0.05); border-radius: 8px; color: var(--color-text-primary);">
                        ${currentPrice.toLocaleString()} sats
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="display: block; color: var(--color-text-secondary); font-size: 13px; margin-bottom: 6px;">New Price (sats)</label>
                    <input type="number" id="newPriceInput" 
                           value="${currentPrice}" 
                           min="546"
                           style="width: 100%; padding: 12px; background: var(--color-bg-primary); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--color-text-primary); font-size: 16px;">
                </div>
                
                <div style="display: flex; gap: 12px;">
                    <button onclick="document.getElementById('updatePriceModal').remove()" 
                            style="flex: 1; padding: 12px; background: #6B7280; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Cancel
                    </button>
                    <button onclick="updateMyListingPrice('${orderId}')" 
                            style="flex: 1; padding: 12px; background: var(--color-primary); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        Update
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Focus no input
        setTimeout(() => document.getElementById('newPriceInput').focus(), 100);
    }
    
    // üí∞ UPDATE MY LISTING PRICE
    async function updateMyListingPrice(orderId) {
        const newPrice = parseInt(document.getElementById('newPriceInput').value);
        
        if (!newPrice || newPrice < 546) {
            alert('Price must be at least 546 sats (dust limit)');
            return;
        }
        
        try {
            const walletType = localStorage.getItem('walletType');
            
            if (walletType !== 'kraywallet') {
                alert('Please connect Kray Wallet to manage listings');
                return;
            }
            
            document.getElementById('updatePriceModal').remove();
            
            const response = await window.krayWallet.updateListingPrice({ 
                orderId, 
                newPrice 
            });
            
            if (response.success) {
                if (response.requiresSignature) {
                    alert('‚úÖ Price updated! Please sign the new PSBT in the extension to activate.');
                } else {
                    alert('‚úÖ Price updated successfully!');
                }
                loadMyListings(); // Reload
            }
        } catch (error) {
            console.error('Error updating price:', error);
            alert('Error: ' + error.message);
        }
    }
    
    async function createMarketplaceListingCard(listing) {
        console.log('   üé® createMarketplaceListingCard() called for:', listing.inscription_id);
        
        const card = document.createElement('div');
        card.className = 'ordinal-card';
        card.style.cssText = 'cursor: pointer; transition: all 0.3s ease;';
        
        // Use data directly from listing (already includes inscription_id, inscription_number)
        const inscriptionNumber = listing.inscription_number || '?';
        const contentType = listing.content_type || 'unknown';
        const inscriptionId = listing.inscription_id;
        
        console.log('      ‚ÑπÔ∏è Inscription #', inscriptionNumber);
        console.log('      ‚ÑπÔ∏è Content type:', contentType);
        console.log('      ‚ÑπÔ∏è Inscription ID:', inscriptionId);
        
        // Determine content
        let contentHtml = `<div style="font-size: 60px;">üìÑ</div>`;
        if (inscriptionId) {
            if (contentType && contentType.startsWith('image/')) {
                const imgUrl = `http://localhost:3000/api/ordinals/${inscriptionId}/content`;
                console.log('      üñºÔ∏è Image URL:', imgUrl);
                contentHtml = `<img src="${imgUrl}" alt="Inscription #${inscriptionNumber}" loading="lazy" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else if (contentType && contentType.startsWith('text/')) {
                contentHtml = `<div style="font-size: 40px;">üìù</div>`;
            } else {
                // Default: try to show as image
                const imgUrl = `http://localhost:3000/api/ordinals/${inscriptionId}/content`;
                contentHtml = `<img src="${imgUrl}" alt="Inscription #${inscriptionNumber}" loading="lazy" style="width: 100%; height: 100%; object-fit: cover;" onerror="this.parentElement.innerHTML='<div style=\\'font-size: 60px;\\'>üìÑ</div>';">`;
            }
        }
        
        // Extract txid and vout from inscription_id (format: txid:vout or txidiVOUT)
        let displayId = inscriptionId;
        if (inscriptionId && inscriptionId.includes('i')) {
            const parts = inscriptionId.split('i');
            const txid = parts[0];
            displayId = `${txid.slice(0, 8)}...${txid.slice(-4)}i${parts[1]}`;
        }
        
        const marketFee = Math.max(Math.floor(listing.price_sats * 0.02), 546);
        const totalCost = listing.price_sats + marketFee;
        
        console.log('      üí∞ Price:', listing.price_sats, 'sats');
        console.log('      üíµ Market fee:', marketFee, 'sats');
        console.log('      üè∑Ô∏è Total:', totalCost, 'sats');
        
        const likesCount = listing.likes_count || 0;
        
        card.innerHTML = `
            <div class="ordinal-image">
                <div class="ordinal-like-section" style="position: absolute; top: 10px; right: 10px; z-index: 10; background: rgba(0,0,0,0.7); padding: 6px 10px; border-radius: 20px; display: flex; align-items: center; gap: 6px; backdrop-filter: blur(10px);">
                    <span class="like-count" style="color: white; font-size: 13px; font-weight: 600;">${likesCount > 0 ? likesCount : ''}</span>
                    <button class="like-btn" data-order-id="${listing.order_id}" style="background: none; border: none; cursor: pointer; font-size: 18px; padding: 0; transition: transform 0.2s;" title="Like this inscription">
                        ü§ç
                    </button>
                </div>
                ${contentHtml}
            </div>
            <div class="ordinal-info">
                <div class="ordinal-id-number">
                    <span class="ordinal-number">#${inscriptionNumber}</span>
                    <span class="ordinal-id" title="${inscriptionId}">${displayId}</span>
                </div>
                <div class="ordinal-price">
                    <span style="font-size: 14px; color: var(--color-text-secondary);">Price</span>
                    <span style="font-size: 18px; font-weight: 700; color: var(--color-primary);">${listing.price_sats.toLocaleString()} sats</span>
                </div>
                <div style="font-size: 12px; color: var(--color-text-secondary); margin-top: 8px;">
                    + Market fee (2%): ${marketFee.toLocaleString()} sats<br>
                    <strong style="color: var(--color-text-primary);">Total: ${totalCost.toLocaleString()} sats</strong>
                </div>
                <button class="buy-btn" onclick="buyAtomicSwapListing('${listing.order_id}', ${listing.price_sats}, '${inscriptionNumber}')" style="
                    width: 100%;
                    padding: 12px;
                    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
                    color: white;
                    border: none;
                    border-radius: var(--radius-md);
                    font-weight: 600;
                    cursor: pointer;
                    margin-top: 12px;
                    transition: all 0.3s ease;
                ">
                    üõí Buy Now
                </button>
            </div>
        `;
        
        // Adicionar event listener para o bot√£o de like
        const likeBtn = card.querySelector('.like-btn');
        if (likeBtn && listing.order_id) {
            likeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                handleAtomicLikeClick(listing.order_id, likeBtn);
            });
            
            // Carregar estado do like (se o usu√°rio j√° curtiu)
            loadAtomicLikeState(listing.order_id, likeBtn);
        }
        
        console.log('      ‚úÖ Card HTML created, returning card element');
        return card;
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üíù ATOMIC SWAP - LIKE SYSTEM (Id√™ntico ao sistema original do app.js)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Carregar estado do like (verificar se o usu√°rio j√° curtiu)
    async function loadAtomicLikeState(orderId, likeBtn) {
        const walletAddress = localStorage.getItem('walletAddress');
        const walletType = localStorage.getItem('walletType');
        
        if (!walletAddress || walletType !== 'kraywallet') {
            return; // Sem wallet conectada, n√£o carregar estado
        }
        
        try {
            const response = await fetch(`http://localhost:3000/api/atomic-likes/${orderId}?address=${walletAddress}`);
            const data = await response.json();
            
            if (data.success && data.user_liked) {
                // Usu√°rio j√° curtiu, mostrar cora√ß√£o vermelho
                likeBtn.textContent = '‚ù§Ô∏è';
                likeBtn.setAttribute('data-liked', 'true');
            }
            
            // Atualizar contador
            const likeCount = likeBtn.parentElement.querySelector('.like-count');
            if (likeCount && data.likes_count > 0) {
                likeCount.textContent = data.likes_count;
            }
        } catch (error) {
            console.error('Error loading like state:', error);
        }
    }
    
    // Manipular click no bot√£o de like
    async function handleAtomicLikeClick(orderId, likeBtn) {
        console.log('üíù Like button clicked:', {
            orderId,
            walletType: localStorage.getItem('walletType'),
            walletAddress: localStorage.getItem('walletAddress')
        });
        
        const walletAddress = localStorage.getItem('walletAddress');
        const walletType = localStorage.getItem('walletType');
        
        // Verificar se wallet est√° conectada
        if (!walletAddress) {
            alert('‚ùå Please connect your wallet to like');
            return;
        }
        
        // Verificar se √© KrayWallet (necess√°rio para assinatura)
        if (walletType !== 'kraywallet') {
            console.error('‚ùå Wrong wallet type:', walletType, '(expected: kraywallet)');
            alert('‚ùå Only KrayWallet supports likes (signature required)');
            return;
        }
        
        console.log('‚úÖ Wallet verified, proceeding with like...');
        
        const isLiked = likeBtn.getAttribute('data-liked') === 'true';
        
        try {
            // Solicitar assinatura da wallet
            const message = isLiked 
                ? `I unlike this offer: ${Date.now()}`
                : `I like this offer: ${Date.now()}`;
            
            // Assinar mensagem (popup vai abrir automaticamente se locked)
            const signResult = await window.krayWallet.signMessage({ message });
            
            if (!signResult || !signResult.signature) {
                throw new Error('Failed to sign message');
            }
            
            // Enviar para API
            const method = isLiked ? 'DELETE' : 'POST';
            const response = await fetch(`http://localhost:3000/api/atomic-likes/${orderId}`, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    address: walletAddress,
                    signature: signResult.signature,
                    message: message
                })
            });
            
            const data = await response.json();
            
            if (!data.success) {
                throw new Error(data.error || 'Failed to process like');
            }
            
            // Atualizar UI
            const likeCount = likeBtn.parentElement.querySelector('.like-count');
            
            if (isLiked) {
                // Unlike
                likeBtn.textContent = 'ü§ç';
                likeBtn.setAttribute('data-liked', 'false');
                console.log('üíî Unliked!');
            } else {
                // Like
                likeBtn.textContent = '‚ù§Ô∏è';
                likeBtn.setAttribute('data-liked', 'true');
                console.log('‚ù§Ô∏è Liked!');
            }
            
            // Atualizar contador
            if (likeCount) {
                likeCount.textContent = data.likes_count > 0 ? data.likes_count : '';
            }
            
        } catch (error) {
            console.error('‚ùå Error processing like:', error);
            alert(`‚ùå ${error.message}`);
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üõí ATOMIC SWAP - BUY LISTING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function buyAtomicSwapListing(orderId, priceSats, inscriptionNumber) {
        console.log('üõí Buying atomic swap listing:', orderId);
        
        const walletType = localStorage.getItem('walletType');
        const walletAddress = localStorage.getItem('walletAddress');
        
        if (!walletType || !walletAddress) {
            alert('‚ö†Ô∏è Please connect your wallet first!');
            return;
        }
        
        if (walletType !== 'kraywallet') {
            alert('‚ö†Ô∏è Atomic swap purchases are currently only supported with Kray Wallet.\n\nSupport for other wallets coming soon!');
            return;
        }
        
        // Check if window.krayWallet is available
        if (!window.krayWallet || typeof window.krayWallet.buyAtomicSwap !== 'function') {
            alert('‚ö†Ô∏è Kray Wallet extension not found or outdated.\n\nPlease make sure the extension is installed and refresh the page.');
            return;
        }
        
        try {
            console.log('üìû Calling window.krayWallet.buyAtomicSwap()...');
        
            // Call Kray Wallet API (popup da wallet vai mostrar o resumo)
            const response = await window.krayWallet.buyAtomicSwap({
                orderId,
                priceSats,
                buyerAddress: walletAddress,
                buyerChangeAddress: walletAddress
            });
            
            console.log('‚úÖ Purchase response:', response);
            
            // ‚úÖ Verificar se requer assinatura ou se j√° tem TXID
            if (response.requiresSignature) {
                // Popup da carteira vai abrir automaticamente
                console.log('‚è≥ Waiting for signature...');
                console.log('   Popup da Kray Wallet deve ter aberto automaticamente');
                // N√ÉO mostrar alert aqui! Apenas aguardar a assinatura
                return; // Sair da fun√ß√£o
            }
            
            // Se chegou aqui, tem TXID (compra finalizada)
            if (response.success && response.txid) {
                alert(`‚úÖ Purchase successful!\n\nTXID: ${response.txid}\n\nThe inscription is now yours!`);
                await loadAtomicSwapListings(); // Reload listings
            } else {
                throw new Error(response.error || 'Purchase failed');
            }
            
        } catch (error) {
            console.error('‚ùå Error buying listing:', error);
            alert(`‚ùå Error: ${error.message}`);
        }
    }
    
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // üé¨ INITIALIZE - Load listings on page load
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    // Load atomic swap listings when browse tab is active
    document.addEventListener('DOMContentLoaded', function() {
        // Load on initial page load
        loadAtomicSwapListings();
        
        // Reload when browse tab is clicked
        const browseTabs = document.querySelectorAll('[data-tab="browse"]');
        browseTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                loadAtomicSwapListings();
            });
        });
    });
    
    </script>
</body>
</html>

